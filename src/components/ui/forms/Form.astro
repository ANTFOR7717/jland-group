---
// Form Component - Enhanced form wrapper with validation and UX features
// Enhanced for optimal responsiveness and mobile user experience
// Adheres to Tailwind CSS only styling as required

export interface Props {
  action?: string;
  method?: 'GET' | 'POST';
  class?: string;
  variant?: 'quote' | 'newsletter' | 'default';
  id?: string;
}

const {
  action,
  method = 'POST',
  class: className = '',
  variant = 'default',
  id = 'form',
  ...rest
} = Astro.props;

// Enhanced responsive base classes
const baseClasses = 'flex flex-col w-full relative';

// Enhanced variant-specific classes with responsive spacing
const variantClasses = {
  default: 'gap-3 sm:gap-4 lg:gap-5',
  quote: 'gap-4 sm:gap-5 lg:gap-6',
  newsletter: 'gap-2 sm:gap-3'
};

const formClasses = `${baseClasses} ${variantClasses[variant]} ${className}`;
const formId = `${id}-${variant}`;
---

<form 
  id={formId}
  class={formClasses}
  action={action}
  method={method}
  novalidate
  {...rest}
>
  <!-- Loading overlay -->
  <div id={`${formId}-loading`} class="absolute inset-0 bg-white/80 backdrop-blur-sm rounded-lg hidden items-center justify-center z-10">
    <div class="flex flex-col items-center gap-3">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <span class="text-sm font-medium text-gray-700">Submitting...</span>
    </div>
  </div>
  
  <!-- Success message -->
  <div id={`${formId}-success`} class="hidden p-4 mb-4 text-green-800 bg-green-100 border border-green-200 rounded-lg" role="alert">
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
      </svg>
      <span class="font-medium">Success!</span>
    </div>
    <p class="mt-1 text-sm">Thank you for your request. We'll contact you within 24 hours.</p>
  </div>
  
  <!-- Error message -->
  <div id={`${formId}-error`} class="hidden p-4 mb-4 text-red-800 bg-red-100 border border-red-200 rounded-lg" role="alert">
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
      </svg>
      <span class="font-medium">Error</span>
    </div>
    <p class="mt-1 text-sm" id={`${formId}-error-message`}>Please check your information and try again.</p>
  </div>
  
  <slot />
</form>

<script>
  // Enhanced form validation and submission handling
  document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form[id*="quote"]');
    
    forms.forEach(form => {
      const formId = form.id;
      const loadingEl = document.getElementById(`${formId}-loading`);
      const successEl = document.getElementById(`${formId}-success`);
      const errorEl = document.getElementById(`${formId}-error`);
      const errorMessageEl = document.getElementById(`${formId}-error-message`);
      
      // Real-time validation
      const inputs = form.querySelectorAll('input, textarea');
      inputs.forEach(input => {
        const typedInput = input as HTMLInputElement | HTMLTextAreaElement;
        typedInput.addEventListener('blur', validateField);
        typedInput.addEventListener('input', clearFieldError);
      });
      
      // Form submission
       form.addEventListener('submit', async function(e: Event) {
         e.preventDefault();
         
         // Validate all fields
         let isValid = true;
         inputs.forEach(input => {
           const typedInput = input as HTMLInputElement | HTMLTextAreaElement;
           if (!validateField.call(typedInput)) {
             isValid = false;
           }
         });
         
         if (!isValid) return;
         
         // Show loading state
         hideMessages();
         showLoading();
         
         try {
           // Simulate form submission (replace with actual endpoint)
           await new Promise<void>(resolve => setTimeout(resolve, 2000));
           
           // Show success
           hideLoading();
           showSuccess();
           (form as HTMLFormElement).reset();
           
         } catch (error) {
           hideLoading();
           showError('Something went wrong. Please try again.');
         }
       });
      
      function validateField(this: HTMLInputElement | HTMLTextAreaElement) {
         const field = this;
         const value = field.value.trim();
        let isValid = true;
        let errorMessage = '';
        
        // Remove existing error styling
        field.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        
        // Required field validation
        if (field.hasAttribute('required') && !value) {
          errorMessage = 'This field is required';
          isValid = false;
        }
        
        // Email validation
        if (field.type === 'email' && value) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(value)) {
            errorMessage = 'Please enter a valid email address';
            isValid = false;
          }
        }
        
        // Phone validation
        if (field.type === 'tel' && value) {
          const phoneRegex = /^[\d\s\-\(\)\+\.]{10,}$/;
          if (!phoneRegex.test(value)) {
            errorMessage = 'Please enter a valid phone number';
            isValid = false;
          }
        }
        
        // Show/hide field error
        const parentNode = field.parentNode;
        if (!parentNode) return isValid;
        
        let errorEl = parentNode.querySelector('.field-error');
        if (!isValid) {
          field.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
          if (!errorEl) {
            errorEl = document.createElement('div');
            errorEl.className = 'field-error text-red-600 text-sm mt-1';
            parentNode.appendChild(errorEl);
          }
          errorEl.textContent = errorMessage;
        } else if (errorEl) {
          errorEl.remove();
        }
        
        return isValid;
      }
      
      function clearFieldError(this: HTMLInputElement | HTMLTextAreaElement) {
         const field = this;
         field.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
        const parentNode = field.parentNode;
        if (!parentNode) return;
        
        const errorEl = parentNode.querySelector('.field-error');
        if (errorEl) {
          errorEl.remove();
        }
      }
      
      function showLoading() {
        if (loadingEl) {
          loadingEl.classList.remove('hidden');
          loadingEl.classList.add('flex');
        }
      }
      
      function hideLoading() {
        if (loadingEl) {
          loadingEl.classList.add('hidden');
          loadingEl.classList.remove('flex');
        }
      }
      
      function showSuccess() {
        if (successEl) {
          successEl.classList.remove('hidden');
          setTimeout(() => {
            successEl.classList.add('hidden');
          }, 5000);
        }
      }
      
      function showError(message: string) {
         if (errorEl && errorMessageEl) {
           errorMessageEl.textContent = message;
           errorEl.classList.remove('hidden');
         }
       }
      
      function hideMessages() {
        if (successEl) successEl.classList.add('hidden');
        if (errorEl) errorEl.classList.add('hidden');
      }
    });
  });
</script>