---
import { getEntry } from 'astro:content';
import Header from '../components/layout/Header.astro';
import Hero from '../components/sections/Hero.astro';
import Services from '../components/sections/Services.astro';
import Testimonials from '../components/sections/Testimonials.astro';
import Process from '../components/sections/Process.astro';
import Partners from '../components/sections/Partners.astro';

import Layout from '../layouts/Layout.astro';
import Contact from '../components/sections/Contact.astro';
import FAQ from '../components/sections/FAQ.astro';
import AboutUs from '../components/sections/AboutUs.astro';
import { client } from '../lib/sanity/client';
import { combineServiceData } from '../lib/helpers';

// Fetch services data at page level
const [servicesData, construction, showcase] = await Promise.all([
  getEntry('services', 'roofing'),
  getEntry('services', 'construction'),
  getEntry('services', 'showcase')
]);

// Fetch all Sanity data in a single optimized query
const sanityData = await client.fetch(`{
  "heroVideo": *[_type == "heroVideo"][0]{ "videoSrc": video.asset->url },
  "testimonialIcon": *[_type == "testimonialIcon"][0]{ "avatarURL": icon.asset->url },
  "projectPhotos": *[_type == "projectPhoto"]{ "url": image.asset->url, alt, tags },
  "roofingServices": *[_type == "roofingServices"]{ title, description, buttonText, buttonHref },
  "constructionServices": *[_type == "constructionServices"]{ title, description, buttonText, buttonHref }
}`);

// Process the fetched data
const heroVideo = sanityData.heroVideo;
const testimonialIcon = sanityData.testimonialIcon;
const allProjectImages = (sanityData.projectPhotos as any[]).map(p => ({ url: p.url, alt: p.alt }));
const constructionServicesContent =  (sanityData.constructionServices as any[]).map(p => ({ title: p.title, description: p.description, buttonText: p.buttonText, buttonHref: p.buttonHref }));
const constructionServicesImages = (sanityData.projectPhotos as any[]).filter(p => p.tags?.includes("construction-services")).map(p => ({ image: p.url, imageAlt: p.alt, tags: p.tags }));
const recentProjectImages = (sanityData.projectPhotos as any[]).filter(p => p.tags?.includes("recent-project")).map(p => ({ url: p.url, alt: p.alt }));
const roofingServicesImages = (sanityData.projectPhotos as any[]).filter(p => p.tags?.includes("roofing-services")).map(p => ({ image: p.url, imageAlt: p.alt, tags: p.tags }));
const roofingServicesContent = (sanityData.roofingServices as any[]).map(p => ({ title: p.title, description: p.description, buttonText: p.buttonText, buttonHref: p.buttonHref }));

const roofingServices = combineServiceData(roofingServicesContent, roofingServicesImages);
const constructionServices = combineServiceData(constructionServicesContent, constructionServicesImages);

// Validate results in one place
if (!servicesData || !construction || !showcase) {
  throw new Error('One or more services data entries are missing');
}
---

<Layout title="JLand Contracting - Devoted Roofing & Construction Services" description="Devoted roofing and construction services in Frederick, MD featuring integrity-driven craftsmanship, reliable warranties, and devoted long-term performance for homes and businesses.">
	<Header />
	<Hero videoSrc={heroVideo?.videoSrc} />
	<Partners />
	<Testimonials images={recentProjectImages} testimonial={testimonialIcon} />
	<Process />
		<Services
		columns={3}
		variant="construction"
		title={construction.data.title}
		decorativeImage={construction.data.decorativeImage}
		services={constructionServices}
		/>
	<AboutUs/>
	 <FAQ />
	 <Contact />

</Layout>
